name: Release

on:
  push:
    branches:
      - main
    paths:
      - mobile/build.gradle.kts
  workflow_dispatch:

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build_and_release:
    name: Build APKs and create release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect version update
        id: version
        shell: bash
        run: |
          set -euo pipefail

          extract_version_code() {
            grep -E 'versionCode\s*=\s*[0-9]+' "$1" | head -n1 | sed -E 's/.*=\s*([0-9]+).*/\1/'
          }

          extract_version_name() {
            grep -E 'versionName\s*=\s*"[^"]+"' "$1" | head -n1 | sed -E 's/.*=\s*"([^"]+)".*/\1/'
          }

          current_file="mobile/build.gradle.kts"
          current_version_code="$(extract_version_code "$current_file")"
          current_version_name="$(extract_version_name "$current_file")"

          previous_file="$(mktemp)"
          if git show "${{ github.event.before }}:$current_file" > "$previous_file" 2>/dev/null; then
            previous_version_code="$(extract_version_code "$previous_file" || true)"
            previous_version_name="$(extract_version_name "$previous_file" || true)"
          else
            previous_version_code=""
            previous_version_name=""
          fi

          should_release="true"
          if [[ "$current_version_code" == "$previous_version_code" && "$current_version_name" == "$previous_version_name" ]]; then
            should_release="false"
          fi

          tag_name="v$current_version_name"
          if git ls-remote --tags origin "refs/tags/$tag_name" | grep -q "$tag_name"; then
            should_release="false"
            echo "Tag $tag_name already exists. Skipping release."
          fi

          echo "should_release=$should_release" >> "$GITHUB_OUTPUT"
          echo "version_code=$current_version_code" >> "$GITHUB_OUTPUT"
          echo "version_name=$current_version_name" >> "$GITHUB_OUTPUT"
          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Copy CI gradle.properties
        if: steps.version.outputs.should_release == 'true'
        run: mkdir -p ~/.gradle ; cp .github/gradle-ci.properties ~/.gradle/gradle.properties

      - name: Set up JDK 21
        if: steps.version.outputs.should_release == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21

      - name: Setup Gradle
        if: steps.version.outputs.should_release == 'true'
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Validate release secrets
        if: steps.version.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.ANDROID_RELEASE_KEYSTORE_B64 }}" ]; then
            echo "ANDROID_RELEASE_KEYSTORE_B64 is required for releases."
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}" ]; then
            echo "ANDROID_RELEASE_STORE_PASSWORD is required for releases."
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}" ]; then
            echo "ANDROID_RELEASE_KEY_ALIAS is required for releases."
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}" ]; then
            echo "ANDROID_RELEASE_KEY_PASSWORD is required for releases."
            exit 1
          fi
          if [ -z "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "PLAY_SERVICE_ACCOUNT_JSON is required for releases."
            exit 1
          fi

      - name: Prepare release keystore
        if: steps.version.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          keystore_path="$RUNNER_TEMP/release-signing.jks"
          echo "${{ secrets.ANDROID_RELEASE_KEYSTORE_B64 }}" | base64 --decode > "$keystore_path"
          chmod 600 "$keystore_path"
          echo "ANDROID_RELEASE_KEYSTORE_PATH=$keystore_path" >> "$GITHUB_ENV"

      - name: Build release artifacts (APK + AAB)
        if: steps.version.outputs.should_release == 'true'
        env:
          ANDROID_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}
          ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
          ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
        run: ./gradlew :mobile:assembleRelease :mobile:bundleRelease

      - name: Validate release APK is signed
        if: steps.version.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if ls mobile/build/outputs/apk/release/*-unsigned.apk >/dev/null 2>&1; then
            echo "Found unsigned release APK. Configure release signing before publishing."
            exit 1
          fi

      - name: Upload to Play Store (Internal Track)
        if: steps.version.outputs.should_release == 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.scrolless.app
          releaseFiles: mobile/build/outputs/bundle/release/*.aab
          track: internal
          status: completed

      - name: Create GitHub Release and upload APK
        if: steps.version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.version.outputs.tag_name }}
          generate_release_notes: true
          files: |
            mobile/build/outputs/apk/release/*.apk
